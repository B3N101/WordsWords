generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model User {
  id                    String                  @id @default(cuid())
  name                  String?
  email                 String                  @unique
  emailVerified         DateTime?
  image                 String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  role                  Role                    @default(STUDENT)
  accounts              Account[]
  quizzes               Quiz[]
  sessions              Session[]
  wordMasteries         UserWordMastery[]
  UserWordsListProgress UserWordsListProgress[]
  Classes               Class[]                 @relation("UserClasses")
}

model Class {
  classId                 String                  @id @default(cuid())
  className               String
  teacherId               String
  SemesterStart           DateTime
  SemesterEnd             DateTime
  userWordsListProgresses UserWordsListProgress[]
  students                User[]                  @relation("UserClasses")
}

model Word {
  wordId               String           @id @default(cuid())
  word                 String
  partOfSpeech         partOfSpeech
  context              String
  definition           String
  incorrectDefinitions String[]
  listId               String?
  exampleSentence      String
  gradeLevel           Grade
  rankWithinList       Int?
  correctFillIn        String
  incorrectFillIns     String[]
  wordListNumber       Int?
  questions            Question[]
  userWordMasteries    UserWordMastery?
  wordsList            WordsList?       @relation(fields: [listId], references: [listId], onDelete: Cascade)
}

model WordsList {
  listId                String                  @id @default(cuid())
  name                  String
  quizzes               Quiz[]
  UserWordsListProgress UserWordsListProgress[]
  words                 Word[]
}

model UserWordsListProgress {
  userId                String
  classId               String
  wordsListListId       String
  quizAttemptsRemaining Int[]             @default([3, 3, 3, 3])
  retakesRequested      Boolean[]         @default([false, false, false, false])
  completed             Boolean           @default(false)
  dueDate               DateTime          @default(dbgenerated("(now() + '7 days'::interval)"))
  quizzes               Quiz[]
  userWordMasteries     UserWordMastery[]
  class                 Class             @relation(fields: [classId], references: [classId])
  user                  User              @relation(fields: [userId], references: [id])
  wordsList             WordsList         @relation(fields: [wordsListListId], references: [listId])

  @@id([userId, wordsListListId], name: "userWordsListProgressId")
}

model UserWordMastery {
  wordId                String                @id
  masteryScore          Float                 @default(0)
  userId                String
  wordsListId           String
  attempts              UserQuestionAttempt[]
  user                  User                  @relation(fields: [userId], references: [id])
  userWordsListProgress UserWordsListProgress @relation(fields: [userId, wordsListId], references: [userId, wordsListListId], onDelete: Cascade)
  word                  Word                  @relation(fields: [wordId], references: [wordId], onDelete: Cascade)
}

model UserQuestionAttempt {
  questionAttemptId String          @id @default(cuid())
  wordId            String
  userId            String
  correct           Boolean
  timeSpent         Int?
  questionAttempt   DateTime        @default(now())
  wordMastery       UserWordMastery @relation(fields: [wordId], references: [wordId], onDelete: Cascade)
}

model Quiz {
  quizId                String                @id @default(cuid())
  quizType              QuizType              @default(MINI)
  completed             Boolean               @default(false)
  completedAt           DateTime?
  createdAt             DateTime              @default(now())
  dueDate               DateTime?
  learnCompleted        Boolean               @default(false)
  length                Int
  miniSetNumber         Int
  name                  String
  score                 Float                 @default(0)
  userId                String
  wordsListId           String
  questions             Question[]
  user                  User                  @relation(fields: [userId], references: [id])
  userWordsListProgress UserWordsListProgress @relation(fields: [userId, wordsListId], references: [userId, wordsListListId], onDelete: Cascade)
  wordsList             WordsList             @relation(fields: [wordsListId], references: [listId])
}

model Question {
  questionId        String   @id @default(cuid())
  rank              Int
  wordId            String
  allAnswers        String[]
  completed         Boolean  @default(false)
  correctAnswer     String
  correctlyAnswered Boolean  @default(false)
  questionString    String
  quizId            String
  quiz              Quiz     @relation(fields: [quizId], references: [quizId], onDelete: Cascade)
  word              Word     @relation(fields: [wordId], references: [wordId], onDelete: Cascade)
}

model RoleRequest {
  userId      String   @unique
  role        Role
  requestDate DateTime @default(now())
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum Grade {
  NINE
  TEN
  ELEVEN
}

enum partOfSpeech {
  Noun
  Verb
  Adjective
}

enum QuizType {
  MINI
  MASTERY
}
